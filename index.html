<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Document</title>
		<style>
canvas {
	image-rendering: optimizeSpeed;
	image-rendering: -webkit-optimize-contrast;
	image-rendering: pixelated;
}

		</style>
	</head>
	<body>
		<canvas id="output" width="512" height="512"></canvas><br>
		<input type="file" id="upload" accept=".json">Pixels Loaded: <span id="bytes">0</span><br>
		<input id="limit" type="range" min=0 max=16384 value=0 style="width: 512px" oninput="refreshImage()">
		<script>
"use strict";

const $=(x)=>{return document.querySelector(x)}

async function retrieve(url) {
  const response = await fetch(url);
  return await response.json();
}


let
	out = $("#output"),
	ctx = out.getContext("2d");

document.onkeydown = (e) => {
	if (e.key == "LeftArrow") {
		$('#limit').value--;
		refreshImage();
	}
	if (e.key == "RightArrow") {
		$('#limit').value++;
		refreshImage();
	}
}

function refreshImage() {
	clearInterval(go);
	currPix = 0;
	displayImg(storeResult, $('#limit').value);
	$('#bytes').innerText=$('#limit').value;
}

function readFileContent(file) {
	const reader = new FileReader();
	return new Promise((resolve, reject) => {
		reader.onload = event => resolve(event.target.result);
		reader.onerror = error => reject(error);
		reader.readAsText(file);
	});
}

function placeFileContent(file) {
	readFileContent(file).then(content => {
		currPix = 0;
		ctx.clearRect(0, 0, out.width, out.height);
		clearInterval(go);
		let stream = JSON.parse(content);
		$('#limit').max = stream.length;
		displayImg(stream, stream.length);
	}).catch(error => console.log(error))
}
upload.onchange = () => {
	const input = event.target;
	if ('files' in input && input.files.length > 0) {
		placeFileContent(input.files[0]);
	}
}

function calcPos(num) {
	let b4 = num.toString(4);
	let x = 0, y = 0, w = 0;
	for (let i = 1; i < b4.length+1; i++) {
		let newVal = b4[b4.length-i];
		let inc = 2 ** (-i)
		switch (newVal) {
			case "0":
				break;
			case "3":
				x += inc;
				break;
			case "2":
				y += inc;
				break;
			case "1":
				x += inc;
				y += inc;
				break;
		}
	}
	w = 2 ** (-b4.length);
	return [x, y, w];
}

function doPixel(result, limit=16384) {
	let coords = calcPos(currPix);
	let [x, y, w] = coords
	let pixel = result[currPix];
	let pixelHex = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
	let boxOffset = -(out.width * w/2)
	ctx.beginPath();
	ctx.rect(x*out.width + boxOffset, y*out.height + boxOffset, out.width * w, out.height * w);
//	ctx.rect(x*out.width, y*out.height, out.width/128, out.height/128);
	ctx.fillStyle = pixelHex;
	ctx.fill();
	currPix++;
	$("#bytes").innerText = currPix;
	if (currPix > limit) {
		clearInterval(go);
	}
}


let currPix = 0;
let storeResult;

let displayImg = (result = storeResult, limit=16384) => {
	storeResult = result;
	ctx.clearRect(0, 0, out.width, out.height);
//	go = setInterval(()=>{
while (currPix <= limit) {
//	document.onkeydown=e=>{if(e.key==" "){
		doPixel(result, limit);
//	}}
//}, 2);
}
}

let go = setInterval(()=>{
	let coords = calcPos(currPix);
	let [x, y, w] = coords
	//let pixel = result[currPix];
	let pixelHex = `black`;
	ctx.beginPath();
	ctx.rect(x*out.width, y*out.height, out.width/64, out.height/64);
	ctx.fillStyle = pixelHex;
	ctx.fill();
	currPix++;
}, 1);


		</script>
	</body>
</html>